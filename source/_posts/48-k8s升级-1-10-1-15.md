---
title: k8s升级(1.10->1.15)
copyright: true
date: 2020-05-18 17:43:27
tags:
  - k8s
categories:
  - [k8s]

---

k8s升级一般不能跨版本升级, 所以这里间断介绍升级过程, 每次升级一个大版本
<!--more-->


### k8s升级


[kubernetes集群版本升级攻略](https://blog.51cto.com/newfly/2440901?source=dra)
[官方kubeadm升级文档](https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/)


### 版本关系

Kubernetes 1.15.0 -->Docker版本1.13.1、17.03、17.06、17.09、18.06、18.09
Kubernetes 1.14.0 -->Docker版本1.13.1、17.03、17.06、17.09、18.06、18.09
Kubernetes 1.13.0 -->Docker版本1.11.1、1.12.1、1.13.1、17.03、17.06、17.09、18.06
Kubernetes 1.11.* -->Docker版本1.11.2到1.13.1、17.03
Kubernetes 1.10.* -->Docker版本1.11.2到1.13.1、17.03



### k8s1.10 -> k8s1.11

-  注意我这里是单机,所以没有禁止调度,集群在升级前需要禁止调度: 

> kubectl taint node master-01 node-role.kubernetes.io/master="":NoExecute
> kubectl taint node --all node-role.kubernetes.io/master-

-  注意备份etcd

```
export ETCDCTL_API=3
# 备份
etcdctl snapshot save backup-$(date +%Y%m%d_%H).db
# 恢复
etcdctl snapshot restore backup-xxxx.db --data-dir=/data/etcd/data
 
```


#### kubeadm升级准备
```
# 保存配置
kubeadm config view > kubeadmin-10-view.conf

# k8s1.10版本要求cni必须是低于kubernetes-cni-0.6.0-0版本
export k8s_version=1.11.0
yum makecache all
version=$(yum list kubeadm --showduplicates | sort -r|grep ${k8s_version}|awk '{print $2}')

yum install -y kubeadm-${version} --disableexcludes=kubernetes


# 查看是否可以更新
kubeadm upgrade plan
[preflight] Running pre-flight checks.
[upgrade] Making sure the cluster is healthy:
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[upgrade] Fetching available versions to upgrade to
[upgrade/versions] Cluster version: v1.10.0
[upgrade/versions] kubeadm version: v1.11.0
[upgrade/versions] WARNING: Couldn't fetch latest stable version from the internet: unable to get URL "https://dl.k8s.io/release/stable.txt": Get https://storage.googleapis.com/kubernetes-release/release/stable.txt: net/http: TLS handshake timeout
[upgrade/versions] WARNING: Falling back to current kubeadm version as latest stable version
[upgrade/versions] WARNING: Couldn't fetch latest version in the v1.10 series from the internet: unable to get URL "https://dl.k8s.io/release/stable-1.10.txt": Get https://storage.googleapis.com/kubernetes-release/release/stable-1.10.txt: dial tcp 172.217.160.112:443: i/o timeout

External components that should be upgraded manually before you upgrade the control plane with 'kubeadm upgrade apply':
COMPONENT   CURRENT   AVAILABLE
Etcd        3.3.11    3.2.18

Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':
COMPONENT   CURRENT       AVAILABLE
Kubelet     1 x v1.10.1   v1.11.0

Upgrade to the latest stable version:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.10.0   v1.11.0
Controller Manager   v1.10.0   v1.11.0
Scheduler            v1.10.0   v1.11.0
Kube Proxy           v1.10.0   v1.11.0
CoreDNS              1.0.6     1.1.3

You can now apply the upgrade by executing the following command:

 kubeadm upgrade apply v1.11.0

_____________________________________________________________________

```


#### 执行升级操作
```
kubeadm upgrade apply v1.11.0 --config kubeadmin-10-view.conf --dry-run

# 修改下kubeadmin-10-view.conf配置 imageRepository: registry.cn-hangzhou.aliyuncs.com/k8sth
docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-proxy-amd64:v1.11.0
docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-controller-manager-amd64:v1.11.0
docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-scheduler-amd64:v1.11.0
docker pull registry.cn-hangzhou.aliyuncs.com/k8sth/kube-apiserver-amd64:v1.11.0

kubeadm upgrade apply v1.11.0 --config kubeadmin-10-view.conf 
```

#### 升级kubelet kubectl

```
yum install -y kubectl-${version} kubelet-${version} --disableexcludes=kubernetes

# 修改下kubelet配置(否则集群会报错)
vim /var/lib/kubelet/kubeadm-flags.env
增加--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1

systemctl daemon-reload
systemctl restart kubelet
kubectl version
kubelet --version
kubectl get nodes
```




### k8s1.11 -> k8s1.12
```
# 保存配置
kubeadm config view > kubeadmin-11-view.conf
# 或者通过configmap
kubectl get configmap -n kube-system kubeadm-config -o jsonpath={.data.MasterConfiguration} > kubeadmin-11-view.conf


export k8s_version=1.12.0
yum makecache all
version=$(yum list kubeadm --showduplicates | sort -r|grep ${k8s_version}|awk '{print $2}')

yum install -y kubeadm-${version} --disableexcludes=kubernetes


kubeadm upgrade plan


#修改image地址(之前是registry.cn-hangzhou.aliyuncs.com/k8sth)
vim kubeadmin-11-view.conf
imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers


kubeadm upgrade apply v1.12.0 --config kubeadmin-11-view.conf --dry-run

docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1


kubeadm upgrade apply v${k8s_version} --config kubeadmin-11-view.conf


yum install -y kubelet-${version} kubectl-${version} --disableexcludes=kubernetes

# 修改下kubelet配置(否则集群会报错)
vim /var/lib/kubelet/kubeadm-flags.env
增加--pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1

systemctl daemon-reload
systemctl restart kubelet
kubectl version
kubelet --version
kubectl get nodes
```



### k8s1.12 -> k8s1.13
```
# 保存配置
export k8s_old_version=1.12.0
export k8s_version=1.13.0
export kubeadm_config=kubeadmin-${k8s_old_version}-view.conf

kubeadm config view > ${kubeadm_config}
# 或者通过configmap
kubectl get configmap -n kube-system kubeadm-config -o jsonpath={.data.ClusterConfiguration} > ${kubeadm_config}

yum makecache all
version=$(yum list kubeadm --showduplicates | sort -r|grep ${k8s_version}|awk '{print $2}')

# 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2)
yum install -y kubeadm-${version} kubelet-${version} kubectl-${version} kubernetes-cni-0.6.0-0 --disableexcludes=kubernetes


kubeadm upgrade plan


kubeadm upgrade apply v${k8s_version}  --config ${kubeadm_config} --dry-run

docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1


kubeadm upgrade apply v${k8s_version} --config ${kubeadm_config}


yum install -y kubelet-${version} kubectl-${version} --disableexcludes=kubernetes

systemctl daemon-reload
systemctl restart kubelet
kubectl version
kubelet --version
kubectl get nodes
```




### k8s1.13 -> k8s1.14
```
# 保存配置
export k8s_old_version=1.13.0
export k8s_version=1.14.0
export kubeadm_config=kubeadmin-${k8s_old_version}-view.conf

# config view或者通过configmap(2选1)
kubeadm config view > ${kubeadm_config}
kubectl get configmap -n kube-system kubeadm-config -o jsonpath={.data.ClusterConfiguration} > ${kubeadm_config}


yum makecache all
version=$(yum list kubeadm --showduplicates | sort -r|grep ${k8s_version}|awk '{print $2}')

# 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) 
# (这里1.14会依赖kubernetes-cni:0.7.5-0)
yum install -y kubeadm-${version} kubelet-${version} kubectl-${version} --disableexcludes=kubernetes

kubeadm upgrade plan

kubeadm upgrade apply v${k8s_version}  --config ${kubeadm_config} --dry-run

docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1


kubeadm upgrade apply v${k8s_version} --config ${kubeadm_config}


systemctl daemon-reload
systemctl restart kubelet
kubectl version
kubelet --version
kubectl get nodes
```

### 升级docker
```
yum install docker-ce-18.09.9 docker-ce-cli-18.09.9

# 重启docker, k8s集群会间断(如果是多台, 将重启的节点taint剔除集群重启即可)
service docker restart

```

### k8s1.14 -> k8s1.15
```
# 保存配置
export k8s_old_version=1.14.0
export k8s_version=1.15.0
export kubeadm_config=kubeadmin-${k8s_old_version}-view.conf

# config view或者通过configmap(2选1)
kubeadm config view > ${kubeadm_config}
kubectl get configmap -n kube-system kubeadm-config -o jsonpath={.data.ClusterConfiguration} > ${kubeadm_config}


yum makecache all
version=$(yum list kubeadm --showduplicates | sort -r|grep ${k8s_version}|awk '{print $2}')

# 一起安装是因为kubeadm安装时会依赖kubelet, kubelet会安装最新版本(1.18.2) 
yum install -y kubeadm-${version} kubelet-${version} kubectl-${version} 

kubeadm upgrade plan

kubeadm upgrade apply v${k8s_version}  --config ${kubeadm_config} --dry-run

docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v${k8s_version}
docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1


kubeadm upgrade apply v${k8s_version} --config ${kubeadm_config}


systemctl daemon-reload
systemctl restart kubelet
kubectl version
kubelet --version
kubectl get nodes
```

#### kubeadm upgrade plan 具体结果
```
 kubeadm upgrade plan
[upgrade/config] Making sure the configuration is correct:
[upgrade/config] Reading configuration from the cluster...
[upgrade/config] FYI: You can look at this config file with 'kubectl -n kube-system get cm kubeadm-config -oyaml'
[preflight] Running pre-flight checks.
[upgrade] Making sure the cluster is healthy:
[upgrade] Fetching available versions to upgrade to
[upgrade/versions] Cluster version: v1.14.0
[upgrade/versions] kubeadm version: v1.15.0
W0518 05:21:52.446954     801 version.go:98] could not fetch a Kubernetes version from the internet: unable to get URL "https://dl.k8s.io/release/stable.txt": Get https://storage.googleapis.com/kubernetes-release/release/stable.txt: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)
W0518 05:21:52.447091     801 version.go:99] falling back to the local client version: v1.15.0
[upgrade/versions] Latest stable version: v1.15.0
W0518 05:22:02.467795     801 version.go:98] could not fetch a Kubernetes version from the internet: unable to get URL "https://dl.k8s.io/release/stable-1.14.txt": Get https://storage.googleapis.com/kubernetes-release/release/stable-1.14.txt: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)
W0518 05:22:02.467847     801 version.go:99] falling back to the local client version: v1.15.0
[upgrade/versions] Latest version in the v1.14 series: v1.15.0

External components that should be upgraded manually before you upgrade the control plane with 'kubeadm upgrade apply':
COMPONENT   CURRENT   AVAILABLE
Etcd        3.3.11    3.3.10

Components that must be upgraded manually after you have upgraded the control plane with 'kubeadm upgrade apply':
COMPONENT   CURRENT       AVAILABLE
Kubelet     1 x v1.14.0   v1.15.0

Upgrade to the latest version in the v1.14 series:

COMPONENT            CURRENT   AVAILABLE
API Server           v1.14.0   v1.15.0
Controller Manager   v1.14.0   v1.15.0
Scheduler            v1.14.0   v1.15.0
Kube Proxy           v1.14.0   v1.15.0
CoreDNS              1.3.1     1.3.1

You can now apply the upgrade by executing the following command:

 kubeadm upgrade apply v1.15.0

_____________________________________________________________________
```




---





### 问题
#### 1. 版本选择的image配置问题
```
开始选择升级到k8s1.11.10版本, 但是镜像版本只有registry.cn-hangzhou.aliyuncs.com/k8sth/kube-proxy-amd64:v1.11.0 , 没有找到v1.11.10
```

#### 2. 1.12版本开始阿里云镜像地址变化
```
registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.12.0
registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1

```

#### 3. 如果执行升级中断或停止, 可以
```
kubeadm upgrade --force。
```
